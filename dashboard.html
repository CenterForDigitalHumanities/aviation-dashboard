<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLU Aviation Weather Dashboard</title>
    <style>
        :root {
            /* Classic light theme (default) */
            --bg-primary: #f4f4f4;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e9e9e9;
            --text-primary: #333;
            --text-secondary: #666;
            --accent-primary: transparent
                /* #0056b3; */
                --border-color: transparent;
            --highlight-bg: #ffdddd;
            --highlight-text: #d32f2f;
            --success-bg: #ddffdd;
            --success-text: #2e7d32;
            --warning-bg: #fffacd;
            --warning-text: #f57c00;
        }

        body.dark-theme {
            /* Dark theme */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #1a1a1a;
            --text-primary: #e0e0e0;
            --text-secondary: #999;
            --accent-primary: #ffa500;
            --border-color: #444;
            --highlight-bg: rgba(244, 67, 54, 0.3);
            --highlight-text: #ff6b6b;
            --success-bg: rgba(76, 175, 80, 0.3);
            --success-text: #81c784;
            --warning-bg: rgba(255, 152, 0, 0.3);
            --warning-text: #ffb74d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100vh;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: var(--bg-secondary);
            padding: 10px 20px;
            border-bottom: 3px solid var(--accent-primary);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: var(--accent-primary);
            font-size: 1.5em;
            text-align: center;
            margin: 0;
            flex: 1;
        }

        .theme-toggle {
            display: none;
            background-color: var(--accent-primary);
            color: var(--bg-secondary);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: opacity 0.2s ease;
            position: relative;
        }

        .theme-toggle:hover {
            opacity: 0.8;
        }

        .theme-toggle::after {
            content: " (Space)";
            font-size: 0.75em;
            opacity: 0.7;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
            overflow-y: auto;
        }

        .card {
            background-color: var(--bg-secondary);
            border: 2px solid var(--accent-primary);
            border-radius: 8px;
            padding: 15px;
            flex-shrink: 0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .card.scrollable {
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        h2,
        h3 {
            color: var(--accent-primary);
            margin: 0 0 10px 0;
            font-size: 1.1em;
            transition: color 0.3s ease;
        }

        .metar-data {
            background-color: var(--bg-tertiary);
            padding: 10px;
            white-space: pre-wrap;
            font-size: 1.2em;
            font-family: 'Courier New', monospace;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85em;
        }

        th,
        td {
            border: 1px solid var(--border-color);
            padding: 6px 8px;
            text-align: left;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        td[rowspan="4"] {
            vertical-align: top;
        }

        th {
            background-color: var(--bg-tertiary);
            color: var(--accent-primary);
            font-weight: bold;
        }

        .highlight {
            background-color: var(--highlight-bg);
            color: var(--highlight-text);
            font-weight: bold;
        }

        .success {
            background-color: var(--success-bg);
            color: var(--success-text);
        }

        .warning {
            background-color: var(--warning-bg);
            color: var(--warning-text);
        }

        .embed-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            background-color: var(--bg-tertiary);
            border-radius: 5px;
            padding: 10px;
            transition: background-color 0.3s ease;
        }

        /* METAR embed wrapper */
        #metar-embed-wrapper {
            width: 100%;
            height: 100%;
        }

        /* Override embed colors based on theme */
        body.dark-theme #metartaf-JepVhm08 {
            background-color: #333333 !important;
            color: #fff !important;
        }

        body.dark-theme #metartaf-JepVhm08:hover,
        body.dark-theme #metartaf-JepVhm08:active,
        body.dark-theme #metartaf-JepVhm08:focus {
            background-color: #444444 !important;
        }

        .weather-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .weather-stat:last-child {
            border-bottom: none;
        }

        .weather-stat strong {
            color: var(--accent-primary);
        }

        .footer {
            text-align: center;
            padding: 5px 10px;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
            font-size: 0.7em;
            flex-shrink: 0;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .footer p {
            margin: 2px 0;
            line-height: 1.3;
        }

        #updateTime {
            color: var(--accent-primary);
            font-weight: bold;
        }

        /* Scrollbar styling */
        .column::-webkit-scrollbar,
        .card.scrollable::-webkit-scrollbar {
            width: 8px;
        }

        .column::-webkit-scrollbar-track,
        .card.scrollable::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .column::-webkit-scrollbar-thumb,
        .card.scrollable::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .column::-webkit-scrollbar-thumb:hover,
        .card.scrollable::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        /* Announcement styles */
        .announcement-item {
            padding: 10px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            margin-bottom: 10px;
            border-left: 4px solid #ff6b35;
            transition: background-color 0.3s ease;
        }

        .announcement-date {
            font-size: 0.75em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .announcement-title {
            font-weight: bold;
            color: var(--accent-primary);
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .announcement-content {
            font-size: 0.85em;
            line-height: 1.3;
        }

        .metar-heading {
            font-size: 0.95em;
        }

        .metar-heading.spaced {
            margin-top: 15px;
        }

        .heat-note {
            font-size: 0.85em;
            margin-bottom: 10px;
        }

        /* Airport closed overlay */
        .airport-closed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(211, 47, 47, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 8px;
        }

        .airport-closed-overlay.active {
            display: flex;
        }

        .airport-closed-message {
            color: white;
            text-align: center;
            padding: 20px;
        }

        .airport-closed-message h2 {
            font-size: 2em;
            margin: 0 0 15px 0;
            color: white;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .airport-closed-message p {
            font-size: 1.2em;
            margin: 10px 0;
            line-height: 1.5;
        }

        .airport-closed-message .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        /* Position overlay only over left column */
        .column:first-child {
            position: relative;
        }
    </style>
</head>

<body>
    <header>
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
            üåô Dark
        </button>
        <h1>SLU Aviation Weather Dashboard</h1>
        <div style="width: 100px;"></div> <!-- Spacer for centering -->
    </header>

    <div class="dashboard-container">
        <!-- Left Column: Restrictions -->
        <div class="column">
            <!-- Airport Closed Overlay (inside left column) -->
            <div id="airportClosedOverlay" class="airport-closed-overlay">
                <div class="airport-closed-message">
                    <div class="icon">üö´</div>
                    <h2>All flights are grounded</h2>
                    <p><strong>See airport announcements for details</strong></p>
                </div>
            </div>

            <div class="card scrollable">
                <h2>Pilot Solo Restrictions</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Restriction Type</th>
                            <th>Condition</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td rowspan="4"><strong>Student Pilot Solo</strong></td>
                            <td>Ceiling &lt; 1,500 ft AGL</td>
                            <td id="studentCeilingStatus"></td>
                        </tr>
                        <tr>
                            <td>Visibility &lt; 3 SM</td>
                            <td id="studentVisibilityStatus"></td>
                        </tr>
                        <tr>
                            <td>Surface winds &gt; 15 kt</td>
                            <td id="studentSurfaceWindStatus"></td>
                        </tr>
                        <tr>
                            <td>Crosswind &gt; 10 kt (RWY 12 or 30)</td>
                            <td id="studentCrosswindStatus"></td>
                        </tr>
                        <tr>
                            <td rowspan="4"><strong>Private Pilot Solo</strong></td>
                            <td>Ceiling &lt; 1,500 ft AGL</td>
                            <td id="privateCeilingStatus"></td>
                        </tr>
                        <tr>
                            <td>Visibility &lt; 3 SM</td>
                            <td id="privateVisibilityStatus"></td>
                        </tr>
                        <tr>
                            <td>Surface winds &gt; 20 kt</td>
                            <td id="privateSurfaceWindStatus"></td>
                        </tr>
                        <tr>
                            <td>Crosswind &gt; 15 kt (RWY 12 or 30)</td>
                            <td id="privateCrosswindStatus"></td>
                        </tr>
                        <tr>
                            <td rowspan="4"><strong>Instrument/Commercial Pilot Solo</strong></td>
                            <td>Ceiling &lt; 1,500 ft AGL</td>
                            <td id="instCommCeilingStatus"></td>
                        </tr>
                        <tr>
                            <td>Visibility &lt; 3 SM</td>
                            <td id="instCommVisibilityStatus"></td>
                        </tr>
                        <tr>
                            <td>Surface winds &gt; 25 kt</td>
                            <td id="instCommSurfaceWindStatus"></td>
                        </tr>
                        <tr>
                            <td>Crosswind &gt; 20 kt (RWY 12 or 30)</td>
                            <td id="instCommCrosswindStatus"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card scrollable">
                <h2>Heat Index and Temperature Flight Restrictions</h2>
                <p class="heat-note"><em>Based on KCPS METAR</em></p>
                <table>
                    <thead>
                        <tr>
                            <th>Restriction</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Heat index ‚â• 105¬∞F: "All Flights Restricted"</td>
                            <td id="hi105Status"></td>
                        </tr>
                        <tr>
                            <td>Heat index ‚â• 100¬∞F: "Diamond Dual and Piper Solo Flights Restricted"</td>
                            <td id="hi100Status"></td>
                        </tr>
                        <tr>
                            <td>Heat index ‚â• 95¬∞F: "Diamond Solo Flights Restricted"</td>
                            <td id="hi95Status"></td>
                        </tr>
                        <tr>
                            <td>Temperature ‚â§ 23¬∞F: "All aircraft must be pre-heated"</td>
                            <td id="temp23Status"></td>
                        </tr>
                        <tr>
                            <td>Temperature ‚â§ 14¬∞F: "No solos or cross-countries"</td>
                            <td id="temp14Status"></td>
                        </tr>
                        <tr>
                            <td>Temperature ‚â§ 5¬∞F: "All Flights Restricted"</td>
                            <td id="temp5Status"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Middle Column: METAR Data -->
        <div class="column">
            <div class="card">
                <h2>METAR Data</h2>
                <h3 class="metar-heading">KCPS METAR</h3>
                <div id="metarKCPS" class="metar-data">Loading KCPS METAR...</div>

                <h3 class="metar-heading spaced">KSTL METAR</h3>
                <div id="metarKSTL" class="metar-data">Loading KSTL METAR...</div>
            </div>

            <div class="card">
                <h2>Current Conditions (KCPS)</h2>
                <div class="weather-stat">
                    <strong>Temperature:</strong>
                    <span id="currentTemp">N/A</span>
                </div>
                <div class="weather-stat">
                    <strong>Humidity:</strong>
                    <span id="currentHumidity">N/A</span>
                </div>
                <div class="weather-stat">
                    <strong>Heat Index:</strong>
                    <span id="heatIndexValue">N/A</span>
                </div>
                <div class="weather-stat">
                    <strong>Surface Winds:</strong>
                    <span id="surfaceWinds">N/A</span>
                </div>
                <div class="weather-stat">
                    <strong>Visibility:</strong>
                    <span id="visibility">N/A</span>
                </div>
                <div class="weather-stat">
                    <strong>Cloud Ceiling:</strong>
                    <span id="cloudCeiling">N/A</span>
                </div>
                <div class="weather-stat">
                    <strong>Crosswind RWY 12 (122¬∞):</strong>
                    <span id="crosswind12">N/A</span>
                </div>
                <div class="weather-stat">
                    <strong>Crosswind RWY 30 (302¬∞):</strong>
                    <span id="crosswind30">N/A</span>
                </div>
            </div>
        </div>

        <!-- Right Column: Airport Announcements & Weather Widget -->
        <div class="column">
            <div class="card scrollable" style="flex: 1;">
                <h2>Airport Announcements</h2>
                <div id="announcements-content">
                    <div class="announcement-item">
                        <div class="announcement-date">Loading...</div>
                        <div class="announcement-title">Please wait</div>
                        <div class="announcement-content">Fetching announcements...</div>
                    </div>
                </div>
            </div>

            <div class="card" style="flex-shrink: 0;">
                <h2>St. Louis Downtown Airport</h2>
                <div id="metar-embed-container" class="embed-container">
                    <!-- Dark theme embed (default visible) -->
                    <div id="metar-embed-dark" class="metar-embed-theme">
                        <a href="https://metar-taf.com/metar/KCPS" id="metartaf-dark"
                            style="font-size:18px; font-weight:500; color:#000; width:100%; height:100%; display:block">METAR
                            St. Louis Downtown Airport</a>
                        <script async
                            src="https://metar-taf.com/embed-js/KCPS?bg_color=333333&layout=landscape&visibility=mi&qnh=inHg&rh=dp&target=dark"></script>
                    </div>

                    <!-- Light theme embed (hidden by default) -->
                    <div id="metar-embed-light" class="metar-embed-theme" style="display: none;">
                        <a href="https://metar-taf.com/metar/KCPS" id="metartaf-light"
                            style="font-size:18px; font-weight:500; color:#000; width:100%; height:100%; display:block">METAR
                            St. Louis Downtown Airport</a>
                        <script async
                            src="https://metar-taf.com/embed-js/KCPS?bg_color=ffffff&layout=landscape&visibility=mi&qnh=inHg&rh=dp&target=light"></script>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Data last updated: <span id="updateTime">N/A</span></p>
        <p>Disclaimer: This page provides general aviation weather information and restrictions for planning purposes
            only. Always consult official weather briefings and Air Traffic Control for actual flight operations.</p>
    </div>

    <!-- Shared weather utilities -->
    <script src="shared-weather.js"></script>

    <script>
        // Theme toggle functionality
        // KCPS approximate coordinates for sunrise/sunset estimation
        const KCPS_LAT = 38.5707;
        const KCPS_LON = -90.1562;

        // Convert a Date to Julian Day (UTC)
        function toJulian(date) {
            return (date / 86400000) + 2440587.5;
        }

        // Convert Julian Day to Date (UTC)
        function fromJulian(j) {
            return new Date((j - 2440587.5) * 86400000);
        }

        // Normalize angle to [0, 2œÄ)
        function norm2pi(x) {
            const t = 2 * Math.PI;
            return x - t * Math.floor(x / t);
        }

        // Compute sunrise and sunset times (SunCalc/NOAA-style) for the provided Date
        function getSunriseSunset(date, lat, lon) {
            const J2000 = 2451545;
            const deg2rad = Math.PI / 180;
            const e = 23.4397 * deg2rad; // obliquity

            const lw = -lon / 360; // note the sign
            const phi = lat * deg2rad;

            const d = toJulian(date) - J2000;

            const n = Math.round(d - 0.0009 - lw);
            const ds = n + 0.0009 + lw;

            const M = (357.5291 + 0.98560028 * (ds)) * deg2rad;
            const C = (1.9148 * Math.sin(M)) + (0.02 * Math.sin(2 * M)) + (0.0003 * Math.sin(3 * M));
            const L = (M + C + (102.9372 * deg2rad) + Math.PI); // ecliptic longitude

            const dec = Math.asin(Math.sin(e) * Math.sin(L));
            const Jnoon = J2000 + ds + (0.0053 * Math.sin(M)) - (0.0069 * Math.sin(2 * L));

            const h0 = -0.83 * deg2rad; // atmospheric refraction
            const cosOmega = (Math.sin(h0) - Math.sin(phi) * Math.sin(dec)) / (Math.cos(phi) * Math.cos(dec));

            if (cosOmega < -1) {
                // Always above horizon
                return { sunrise: fromJulian(Jnoon - 0.5), sunset: fromJulian(Jnoon + 0.5) };
            }
            if (cosOmega > 1) {
                // Always below horizon
                return { sunrise: fromJulian(Jnoon + 0.5), sunset: fromJulian(Jnoon - 0.5) };
            }

            const omega = Math.acos(cosOmega);
            const Jrise = Jnoon - omega / (2 * Math.PI);
            const Jset = Jnoon + omega / (2 * Math.PI);
            return { sunrise: fromJulian(Jrise), sunset: fromJulian(Jset) };
        }

        function isDaylightNow(lat = KCPS_LAT, lon = KCPS_LON) {
            const now = new Date();
            // Compute for the actual current time (library handles day selection)
            const { sunrise, sunset } = getSunriseSunset(now, lat, lon);
            return now >= sunrise && now < sunset;
        }

        function applyTheme(isDark) {
            const body = document.body;
            body.classList[`${isDark ? 'add' : 'remove'}`]('dark-theme');
            updateThemeButton(isDark);
            toggleMetarEmbedVisibility(isDark);
        }

        function scheduleNextAutoTheme(lat = KCPS_LAT, lon = KCPS_LON) {
            const now = new Date();
            const { sunrise, sunset } = getSunriseSunset(now, lat, lon);

            let nextSwitch;
            if (now < sunrise) {
                nextSwitch = sunrise;
            } else if (now < sunset) {
                nextSwitch = sunset;
            } else {
                // compute tomorrow's sunrise
                const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                const { sunrise: sunriseTomorrow } = getSunriseSunset(tomorrow, lat, lon);
                nextSwitch = sunriseTomorrow;
            }

            const delay = Math.max(1000, nextSwitch.getTime() - now.getTime());
            setTimeout(() => {
                const isDark = !isDaylightNow(lat, lon);
                applyTheme(isDark);
                // Schedule the subsequent switch
                scheduleNextAutoTheme(lat, lon);
            }, delay);
        }

        function initThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const body = document.body;

            // Determine initial theme purely by sun times (no saved preference)
            const isDark = !isDaylightNow(KCPS_LAT, KCPS_LON);
            applyTheme(isDark);

            // Schedule auto switches at sunrise/sunset
            scheduleNextAutoTheme(KCPS_LAT, KCPS_LON);

            // Toggle theme on button click
            themeToggle.addEventListener('click', toggleTheme);

            // Toggle theme on spacebar press
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    toggleTheme();
                }
            });
        }

        function toggleMetarEmbedVisibility(isDark) {
            const darkEmbed = document.getElementById('metar-embed-dark');
            const lightEmbed = document.getElementById('metar-embed-light');

            if (isDark) {
                darkEmbed.style.display = 'block';
                lightEmbed.style.display = 'none';
            } else {
                darkEmbed.style.display = 'none';
                lightEmbed.style.display = 'block';
            }
            refreshMetarTafWidget();
        }

        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-theme');

            // Update button text
            updateThemeButton(isDark);

            // Toggle METAR embed visibility
            toggleMetarEmbedVisibility(isDark);
        }

        function updateThemeButton(isDark) {
            const themeToggle = document.getElementById('themeToggle');
            if (isDark) {
                themeToggle.innerHTML = 'üåô Dark';
            } else {
                themeToggle.innerHTML = '‚òÄÔ∏è Classic';
            }
        }

        // Initialize theme toggle
        document.addEventListener('DOMContentLoaded', initThemeToggle);

        const KCPS_RUNWAY_12_HDG = 122;
        const KCPS_RUNWAY_30_HDG = 302;

        /**
         * Refresh the METAR-TAF widget by re-running the vendor script
         * Only refresh the currently visible theme to avoid widget-limit errors
         */
        function refreshMetarTafWidget() {
            const isDark = document.body.classList.contains('dark-theme');
            const theme = isDark ? 'dark' : 'light';
            const container = document.getElementById(`metar-embed-${theme}`);
            if (!container) return;

            // Generate a unique ID for this widget instance
            const uniqueId = 'metartaf-' + theme + '-' + Date.now();

            // Completely replace the container contents with fresh anchor and script
            container.innerHTML = `
                <a href="https://metar-taf.com/metar/KCPS" id="${uniqueId}" style="font-size:18px; font-weight:500; color:#000; width:100%; height:100%; display:block">METAR St. Louis Downtown Airport</a>
            `;

            // Create and inject a fresh script tag with the new target ID
            const script = document.createElement('script');
            script.async = true;
            const bgColor = theme === 'dark' ? '333333' : 'ffffff';
            script.src = `https://metar-taf.com/embed-js/KCPS?bg_color=${bgColor}&layout=landscape&visibility=mi&qnh=inHg&rh=dp&target=${uniqueId}`;
            
            container.appendChild(script);
        }

        async function getWeatherData() {
            try {
                const data = await fetchWeatherDataFromJSON();
                if (!data) {
                    throw new Error('Failed to fetch weather data');
                }

                // Update timestamp
                const updateTimeElement = document.getElementById('updateTime');
                if (updateTimeElement) {
                    updateTimeElement.textContent = new Date().toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                }

                // Display METAR data
                if (data.kcps && data.kcps.metar) {
                    document.getElementById("metarKCPS").innerText = data.kcps.metar;
                } else {
                    document.getElementById("metarKCPS").innerText = "KCPS METAR unavailable";
                }

                if (data.kstl && data.kstl.metar) {
                    document.getElementById("metarKSTL").innerText = data.kstl.metar;
                } else {
                    document.getElementById("metarKSTL").innerText = "KSTL METAR unavailable";
                }

                // Use KCPS data preferentially
                const weatherData = data.kcps || data.kstl;

                if (!weatherData) {
                    console.error("No valid weather data available");
                    return;
                }

                // Update current conditions display
                updateCurrentConditions(weatherData);

                // Calculate and update restrictions
                updateRestrictions(weatherData);

                // Refresh the METAR-TAF widget to get latest data
                refreshMetarTafWidget();

            } catch (err) {
                console.error("Error fetching weather data:", err);
                document.getElementById("metarKCPS").innerText = "Error loading weather data";
                document.getElementById("metarKSTL").innerText = "Error loading weather data";
            }
        }

        function updateCurrentConditions(data) {
            // Temperature
            if (data.temperatureC !== undefined && data.temperatureC !== null) {
                const tempF = data.temperatureC * 9 / 5 + 32;
                document.getElementById('currentTemp').textContent = `${tempF.toFixed(1)}¬∞F (${data.temperatureC.toFixed(1)}¬∞C)`;
            }

            // Humidity and Heat Index
            if (data.temperatureC !== undefined && data.dewPointC !== undefined) {
                const tempC = data.temperatureC;
                const dewpointC = data.dewPointC;
                const tempF = tempC * 9 / 5 + 32;
                const dewpointF = dewpointC * 9 / 5 + 32;

                const humidity = 100 * Math.exp((17.625 * dewpointC) / (243.04 + dewpointC)) / Math.exp((17.625 * tempC) / (243.04 + tempC));
                document.getElementById('currentHumidity').textContent = `${humidity.toFixed(0)}%`;

                const heatIndex = calculateHeatIndex(tempF, humidity);
                document.getElementById('heatIndexValue').textContent = heatIndex !== null ? `${heatIndex.toFixed(1)}¬∞F` : 'N/A';
            }

            // Wind
            if (data.windSpeed !== undefined && data.windSpeed !== null) {
                const windDir = data.windDirection || 0;
                const gustText = ((data.windGust ?? 0) > 0) ? ` G${data.windGust}` : '';
                document.getElementById('surfaceWinds').textContent = `${windDir}¬∞ @ ${data.windSpeed} kt${gustText}`;
            }

            // Visibility
            if (data.visibility !== undefined && data.visibility !== null) {
                document.getElementById('visibility').textContent = `${data.visibility} SM`;
            }

            // Ceiling (METAR reports ceiling in AGL, not MSL)
            if (data.cloudCeiling !== undefined && data.cloudCeiling !== null) {
                if (data.cloudCeiling >= 99999) {
                    document.getElementById('cloudCeiling').textContent = 'Clear/No Ceiling';
                } else {
                    document.getElementById('cloudCeiling').textContent = `${data.cloudCeiling} ft AGL`;
                }
            }

            // Crosswind
            if (data.windDirection != null && data.windSpeed != null) {
                const crosswind12 = calculateCrosswind(data.windDirection, data.windSpeed, KCPS_RUNWAY_12_HDG, data.windGust);
                const crosswind30 = calculateCrosswind(data.windDirection, data.windSpeed, KCPS_RUNWAY_30_HDG, data.windGust);

                document.getElementById('crosswind12').textContent = `${crosswind12.toFixed(1)} kt`;
                document.getElementById('crosswind30').textContent = `${crosswind30.toFixed(1)} kt`;
            }
        }

        function updateRestrictions(data) {
            // Note: METAR cloudCeiling is already in AGL (Above Ground Level)
            const visibilitySM = data.visibility;
            const effectiveWindSpeed = getEffectiveWindSpeed(data.windSpeed, data.windGust);
            
            let crosswind12 = null;
            let crosswind30 = null;
            if (data.windDirection != null && data.windSpeed != null) {
                crosswind12 = calculateCrosswind(data.windDirection, data.windSpeed, KCPS_RUNWAY_12_HDG, data.windGust);
                crosswind30 = calculateCrosswind(data.windDirection, data.windSpeed, KCPS_RUNWAY_30_HDG, data.windGust);
            }
            
            // Student Pilot Restrictions (Ceiling unified to 1,500 ft AGL)
            setStatus('studentCeilingStatus', isCeilingRestricted(data.cloudCeiling), 'RESTRICTED: Ceiling too low');
            setStatus('studentVisibilityStatus', isVisibilityRestricted(visibilitySM), 'RESTRICTED: Visibility too low');
            setStatus('studentSurfaceWindStatus', effectiveWindSpeed !== null && effectiveWindSpeed > 15, 'RESTRICTED: Surface winds too high');
            setStatus('studentCrosswindStatus', 
                (crosswind12 !== null && crosswind12 > 10) || (crosswind30 !== null && crosswind30 > 10), 
                'RESTRICTED: Crosswind too high');
            
            // Private Pilot Restrictions (Ceiling unified to 1,500 ft AGL)
            setStatus('privateCeilingStatus', isCeilingRestricted(data.cloudCeiling), 'RESTRICTED: Ceiling too low');
            setStatus('privateVisibilityStatus', isVisibilityRestricted(visibilitySM), 'RESTRICTED: Visibility too low');
            setStatus('privateSurfaceWindStatus', effectiveWindSpeed !== null && effectiveWindSpeed > 20, 'RESTRICTED: Surface winds too high');
            setStatus('privateCrosswindStatus', 
                (crosswind12 !== null && crosswind12 > 15) || (crosswind30 !== null && crosswind30 > 15), 
                'RESTRICTED: Crosswind too high');
            
            // Instrument/Commercial Pilot Restrictions
            setStatus('instCommVisibilityStatus', isVisibilityRestricted(visibilitySM), 'RESTRICTED: Visibility too low');
            setStatus('instCommCeilingStatus', isCeilingRestricted(data.cloudCeiling), 'RESTRICTED: Ceiling too low');
            setStatus('instCommSurfaceWindStatus', effectiveWindSpeed !== null && effectiveWindSpeed > 25, 'RESTRICTED: Surface winds too high');
            setStatus('instCommCrosswindStatus', 
                (crosswind12 !== null && crosswind12 > 20) || (crosswind30 !== null && crosswind30 > 20), 
                'RESTRICTED: Crosswind too high');            // Heat Index / Temperature Restrictions
            if (data.temperatureC !== undefined && data.temperatureC !== null) {
                const tempF = data.temperatureC * 9 / 5 + 32;

                if (data.dewPointC !== undefined && tempF >= 80) {
                    const dewpointF = data.dewPointC * 9 / 5 + 32;
                    const heatIndex = calculateHeatIndex(tempF, dewpointF);

                    setStatus('hi105Status', heatIndex >= 105, 'All Flights Restricted');
                    setStatus('hi100Status', heatIndex >= 100, 'Diamond Dual and Piper Solo Flights Restricted');
                    setStatus('hi95Status', heatIndex >= 95, 'Diamond Solo Flights Restricted');
                } else {
                    setStatus('hi105Status', false, 'OK');
                    setStatus('hi100Status', false, 'OK');
                    setStatus('hi95Status', false, 'OK');
                }

                setStatus('temp23Status', tempF <= 23, 'All aircraft must be pre-heated');
                setStatus('temp14Status', tempF <= 14, 'No solos or cross-countries');
                setStatus('temp5Status', tempF <= 5, 'All Flights Restricted');
            }
        }

        function setStatus(elementId, conditionMet, restrictionText) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if (conditionMet) {
                element.className = 'highlight';
                element.textContent = restrictionText;
            } else {
                element.className = 'success';
                element.textContent = 'OK';
            }
        }

        async function fetchAnnouncements() {
            try {
                const owner = 'CenterForDigitalHumanities';
                const repo = 'aviation-dashboard';

                const discussionsUrl = `https://api.github.com/repos/${owner}/${repo}/discussions`;

                const response = await fetch(discussionsUrl, {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    console.warn(`GitHub API returned ${response.status}, falling back to default announcement`);
                    showDefaultAnnouncement();
                    return;
                }

                const discussions = await response.json();

                const announcements = discussions
                    .filter(d => d.category?.name === 'Announcements')
                    .filter(d => d.state === 'open')
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    .slice(0, 10)
                    .map(d => ({
                        title: d.title,
                        content: d.body || '',
                        date: d.created_at
                    }));

                if (announcements.length === 0) {
                    showDefaultAnnouncement();
                    return;
                }

                displayAnnouncements(announcements);

            } catch (error) {
                console.error('Error fetching announcements:', error);
                showDefaultAnnouncement();
            }
        }

        function displayAnnouncements(announcements) {
            const container = document.getElementById('announcements-content');

            // Check if any OPEN announcement contains #noflying
            const hasNoFlying = announcements.some(a =>
                (a.title && a.title.toLowerCase().includes('#noflying')) ||
                (a.content && a.content.toLowerCase().includes('#noflying'))
            );

            // Show/hide overlay based on #noflying presence (auto-dismisses when announcement closed)
            const overlay = document.getElementById('airportClosedOverlay');
            if (overlay) {
                if (hasNoFlying) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }

            container.innerHTML = announcements.map(announcement => {
                const date = new Date(announcement.date);
                const formattedDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });

                const strippedContent = announcement.content.replace(/<[^>]*>/g, '');
                const truncatedContent = strippedContent.length > 200
                    ? strippedContent.substring(0, 200) + '...'
                    : strippedContent;

                return `
                    <div class="announcement-item">
                        <div class="announcement-date">${formattedDate}</div>
                        <div class="announcement-title">${announcement.title}</div>
                        <div class="announcement-content">${truncatedContent}</div>
                    </div>
                `;
            }).join('');
        }

        function showDefaultAnnouncement() {
            const container = document.getElementById('announcements-content');
            container.innerHTML = `
                <div class="announcement-item">
                    <div class="announcement-date">October 9, 2025</div>
                    <div class="announcement-title">Welcome to the Aviation Dashboard</div>
                    <div class="announcement-content">This dashboard provides real-time weather conditions and flight restrictions for SLU Aviation operations. Please check this section regularly for important updates.</div>
                </div>
            `;
        }

        // Initial fetch on page load
        getWeatherData();
        fetchAnnouncements();

        // Set up auto-refresh timers
        setInterval(getWeatherData, 300000); // Refresh weather every 5 minutes
        setInterval(fetchAnnouncements, 900000); // Refresh announcements every 15 minutes
    </script>
</body>

</html>
