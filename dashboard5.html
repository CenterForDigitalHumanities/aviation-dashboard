<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SLU Aviation Weather Restrictions</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
    h1, h2 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #4CAF50; color: white; }
    .highlight { background-color: #ffcccc; font-weight: bold; }
    .metar { background-color: #e0e0e0; padding: 10px; margin-bottom: 20px; white-space: pre-wrap; }
</style>
</head>
<body>
<h1>Saint Louis University Oliver L. Parks Department of Aviation Science</h1>
<h2>Current Weather and Flight Restrictions</h2>

<h3>Latest METAR Data</h3>
<div class="metar" id="kcps-metar">KCPS METAR: Loading...</div>
<div class="metar" id="kstl-metar">KSTL METAR: Loading...</div>

<h3>Current Weather Conditions (KCPS)</h3>
<p id="weather-conditions">Temperature: Loading... | Relative Humidity: Loading...</p>

<h3>Pilot Restrictions</h3>
<table>
<tr>
    <th>Pilot Type</th><th>Ceiling < 1,500 ft AGL</th><th>Visibility < 3 SM</th>
    <th>Surface Winds</th><th>Crosswind Runway 12</th><th>Crosswind Runway 30</th><th>Status</th>
</tr>
<tr id="student-restrictions">
    <td>Student Pilot</td><td id="student-ceiling">...</td><td id="student-visibility">...</td>
    <td id="student-winds">...</td><td id="student-crosswind-12">...</td><td id="student-crosswind-30">...</td><td id="student-status">...</td>
</tr>
<tr id="private-restrictions">
    <td>Private Pilot</td><td id="private-ceiling">...</td><td id="private-visibility">...</td>
    <td id="private-winds">...</td><td id="private-crosswind-12">...</td><td id="private-crosswind-30">...</td><td id="private-status">...</td>
</tr>
<tr id="instrument-restrictions">
    <td>Instrument/Commercial</td><td id="instrument-ceiling">...</td><td id="instrument-visibility">...</td>
    <td id="instrument-winds">...</td><td id="instrument-crosswind-12">...</td><td id="instrument-crosswind-30">...</td><td id="instrument-status">...</td>
</tr>
</table>

<h3>Heat Index and Temperature Restrictions</h3>
<table>
<tr><th>Condition</th><th>Status</th></tr>
<tr id="heat-index-105"><td>Heat Index ≥ 105°F: All Flights Restricted</td><td id="heat-index-105-status">...</td></tr>
<tr id="heat-index-100"><td>Heat Index ≥ 100°F: Diamond Flights Restricted</td><td id="heat-index-100-status">...</td></tr>
<tr id="temp-32"><td>Temperature < 32°F: Avoid extended power-off ops</td><td id="temp-32-status">...</td></tr>
<tr id="temp-23"><td>Temperature ≤ 23°F: Preheat or recent flight required</td><td id="temp-23-status">...</td></tr>
<tr id="temp-14"><td>Temperature ≤ 14°F: No solos or cross-countries</td><td id="temp-14-status">...</td></tr>
<tr id="temp-5"><td>Temperature ≤ 5°F: All Flights Restricted</td><td id="temp-5-status">...</td></tr>
</table>

<!-- Shared weather utilities -->
<script src="shared-weather.js"></script>

<script>
const kcpsElevation = 413
const currentTime = new Date()  // current UTC time
const twoHoursAgo = new Date(currentTime - 2 * 60 * 60 * 1000)

function clearHighlights() {
    ["student","private","instrument"].forEach(id =>
        document.getElementById(id+"-restrictions").classList.remove("highlight"));
    ["heat-index-105","heat-index-100","temp-32","temp-23","temp-14","temp-5"].forEach(id =>
        document.getElementById(id).classList.remove("highlight"));
}

function checkRestrictions(data, elevation) {
    clearHighlights();
    const ceilingCloud = (() => {
        const clouds = data.clouds ?? []
        const str = clouds.find(c => typeof c === 'string' && (c.startsWith('BKN') || c.startsWith('OVC')))
        if (str) return str
        let num = clouds.find(c => typeof c === 'number')
        if (num == null) {
            const numStr = clouds.find(c => typeof c === 'string' && /^\d+$/.test(c))
            if (numStr) num = parseInt(numStr, 10)
        }
        if (num == null) return undefined
        // treat sentinel like 99999 as infinite/no ceiling
        if (num >= 99999) return undefined
        const hundreds = Math.max(1, Math.round(num / 100))
        return 'BKN' + String(hundreds).padStart(3, '0')
    })()
    const ceiling = ceilingCloud ? parseInt(ceilingCloud.substring(3)) * 100 - elevation : Infinity;
    const cross12 = calculateCrosswind(data.windDir, data.windSpeed, 120);
    const cross30 = calculateCrosswind(data.windDir, data.windSpeed, 300);
    const tempF = toFahrenheit(data.temperature);
    const rh = Math.min(calculateHumidity(data.temperature, data.dewpoint), 100);
    const hi = calculateHeatIndex(tempF, rh);

    document.getElementById("weather-conditions").innerText =
        `Temperature: ${tempF.toFixed(1)}°F | Relative Humidity: ${rh.toFixed(0)}%`;

    [["student",1500,3,20,10,10],["private",1500,3,25,15,15],["instrument",null,3,30,20,20]].forEach(rule=>{
        const [type, ceilLimit, visLimit, windLimit, cross12Limit, cross30Limit] = rule;
        const ceilingOK = ceilLimit ? ceiling >= ceilLimit : true;
        const visOK = data.visibility >= visLimit;
        const windOK = data.windSpeed < windLimit;
        const cross12OK = cross12 <= cross12Limit;
        const cross30OK = cross30 <= cross30Limit;

        document.getElementById(`${type}-ceiling`).innerText = ceilLimit ? (ceilingOK ? "✓":"✗") : "N/A";
        document.getElementById(`${type}-visibility`).innerText = visOK ? "✓":"✗";
        document.getElementById(`${type}-winds`).innerText = windOK ? "✓":"✗";
        document.getElementById(`${type}-crosswind-12`).innerText = cross12OK ? "✓":"✗";
        document.getElementById(`${type}-crosswind-30`).innerText = cross30OK ? "✓":"✗";

        const allowed = ceilingOK && visOK && windOK && cross12OK && cross30OK;
        document.getElementById(`${type}-status`).innerText = allowed ? "Solo Allowed" : "No Solo Allowed";
        if (!allowed) document.getElementById(`${type}-restrictions`).classList.add("highlight");
    });

    [["heat-index-105", hi>=105],["heat-index-100", hi>=100],["temp-32", tempF<32],
     ["temp-23", tempF<=23],["temp-14", tempF<=14],["temp-5", tempF<=5]].forEach(([id, restrict])=>{
        document.getElementById(`${id}-status`).innerText = restrict ? "Restricted" : "Not Restricted";
        if (restrict) document.getElementById(id).classList.add("highlight");
    });
}

async function fetchWeatherData() {
    try {
        // Try to fetch from pre-parsed JSON first
        const jsonData = await fetchWeatherDataFromJSON();
        
        if (jsonData) {
            console.log("Using weather data from JSON file");
            
            // Always display both METARs
            if (jsonData.kcps && jsonData.kcps.metar) {
                document.getElementById("kcps-metar").innerText = `KCPS METAR:\n${jsonData.kcps.metar}`;
            }
            
            if (jsonData.kstl && jsonData.kstl.metar) {
                document.getElementById("kstl-metar").innerText = `KSTL METAR:\n${jsonData.kstl.metar}`;
            }
            
            // Process KCPS data for restrictions if recent
            if (jsonData.kcps && jsonData.kcps.metar) {
                const kcpsData = {
                    windDir: jsonData.kcps.windDirection || 0,
                    windSpeed: jsonData.kcps.windSpeed || 0,
                    visibility: jsonData.kcps.visibility || 10,
                    clouds: jsonData.kcps.cloudCeiling ? [jsonData.kcps.cloudCeiling] : [],
                    temperature: jsonData.kcps.temperatureC || 0,
                    dewpoint: jsonData.kcps.dewPointC || 0,
                    timestamp: jsonData.kcps.timestamp ? new Date(jsonData.kcps.timestamp) : null
                };
                
                if (kcpsData.timestamp && kcpsData.timestamp >= twoHoursAgo) {
                    checkRestrictions(kcpsData, kcpsElevation);
                    return; // Exit after processing KCPS
                }
            }
            
            // If KCPS is old or unavailable, use KSTL data for restrictions
            if (jsonData.kstl && jsonData.kstl.metar) {
                const kstlData = {
                    windDir: jsonData.kstl.windDirection || 0,
                    windSpeed: jsonData.kstl.windSpeed || 0,
                    visibility: jsonData.kstl.visibility || 10,
                    clouds: jsonData.kstl.cloudCeiling ? [jsonData.kstl.cloudCeiling] : [],
                    temperature: jsonData.kstl.temperatureC || 0,
                    dewpoint: jsonData.kstl.dewPointC || 0,
                    timestamp: jsonData.kstl.timestamp ? new Date(jsonData.kstl.timestamp) : null
                };
                
                if (kstlData.timestamp && kstlData.timestamp >= twoHoursAgo) {
                    checkRestrictions(kstlData, 605);
                }
            }
        } else {
            console.warn("Could not load weather data from JSON file");
            document.getElementById("kcps-metar").innerText = "Weather data unavailable";
        }
    } catch (err) {
        console.error("Error fetching weather data:", err);
        document.getElementById("kcps-metar").innerText = "Error loading weather data";
    }
}
fetchWeatherData();
</script>
</body>
</html>
