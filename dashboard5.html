<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SLU Aviation Weather Restrictions</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
    h1, h2 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #4CAF50; color: white; }
    .highlight { background-color: #ffcccc; font-weight: bold; }
    .metar { background-color: #e0e0e0; padding: 10px; margin-bottom: 20px; white-space: pre-wrap; font-size: 1.2em; font-family: monospace;}
    
    .announcements-section {
        background-color: #fff8dc;
        border: 2px solid #ffa500;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .announcement-item {
        margin-bottom: 15px;
        padding: 10px;
        border-left: 4px solid #ff6b35;
        background-color: #f9f9f9;
    }
    
    .announcement-date {
        font-size: 0.9em;
        color: #666;
        font-weight: bold;
    }
    
    .announcement-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    
    .announcement-content {
        margin-bottom: 0;
    }
    
    .hidden {
        display: none;
    }
    
    .flight-status-card {
        background-color: #f8f9fa;
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        font-size: 1.1em;
        margin: 15px 0;
    }
    
    .flight-status-card.all-clear {
        background-color: #d4edda;
        border-color: #28a745;
        color: #155724;
    }
    
    .flight-status-card.commercial-only {
        background-color: #fff3cd;
        border-color: #ffc107;
        color: #856404;
    }
    
    .flight-status-card.private-only {
        background-color: #f8d7da;
        border-color: #fd7e14;
        color: #721c24;
    }
    
    .flight-status-card.all-restricted {
        background-color: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
    }
    
    .status-title {
        font-size: 1.4em;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .status-details {
        font-size: 0.9em;
        margin-top: 8px;
    }
</style>
</head>
<body>
<h1>Saint Louis University Oliver L. Parks Department of Aviation Science</h1>
<h2>Current Weather and Flight Restrictions</h2>

<h3>Current Flight Status</h3>
<div id="overall-flight-status" class="flight-status-card">
    <div class="status-title">Checking conditions...</div>
    <div class="status-details"></div>
</div>

<div class="announcements-section">
    <h3>Service Announcements</h3>
    <div id="announcements-content">
        <div class="announcement-item">
            <div class="announcement-date">Loading...</div>
            <div class="announcement-title">Loading announcements...</div>
            <div class="announcement-content">Please wait while we fetch the latest service announcements.</div>
        </div>
    </div>
</div>

<h3>Latest METAR Data</h3>
<div class="metar" id="kcps-metar">KCPS METAR: Loading...</div>
<div class="metar" id="kstl-metar">KSTL METAR: Loading...</div>

<h3>Current Weather Conditions (KCPS)</h3>
<p id="weather-conditions">Temperature: Loading... | Relative Humidity: Loading...</p>

<h3>Heat Index and Temperature Restrictions</h3>
<table>
<tr><th>Condition</th><th>Status</th></tr>
<tr id="heat-index-105"><td>Heat Index ‚â• 105¬∞F: All Flights Restricted</td><td id="heat-index-105-status">...</td></tr>
<tr id="heat-index-100"><td>Heat Index ‚â• 100¬∞F: Diamond Flights Restricted</td><td id="heat-index-100-status">...</td></tr>
<tr id="temp-32"><td>Temperature < 32¬∞F: Avoid extended power-off ops</td><td id="temp-32-status">...</td></tr>
<tr id="temp-23"><td>Temperature ‚â§ 23¬∞F: Preheat or recent flight required</td><td id="temp-23-status">...</td></tr>
<tr id="temp-14"><td>Temperature ‚â§ 14¬∞F: No solos or cross-countries</td><td id="temp-14-status">...</td></tr>
<tr id="temp-5"><td>Temperature ‚â§ 5¬∞F: All Flights Restricted</td><td id="temp-5-status">...</td></tr>
</table>

<!-- Shared weather utilities -->
<script src="shared-weather.js"></script>

<script>
const kcpsElevation = 413
const currentTime = new Date()  // current UTC time
const twoHoursAgo = new Date(currentTime - 2 * 60 * 60 * 1000)

function checkRestrictions(data, elevation) {
    const ceilingCloud = (() => {
        const clouds = data.clouds ?? []
        const str = clouds.find(c => typeof c === 'string' && (c.startsWith('BKN') || c.startsWith('OVC')))
        if (str) return str
        let num = clouds.find(c => typeof c === 'number')
        if (num == null) {
            const numStr = clouds.find(c => typeof c === 'string' && /^\d+$/.test(c))
            if (numStr) num = parseInt(numStr, 10)
        }
        if (num == null) return undefined
        // treat sentinel like 99999 as infinite/no ceiling
        if (num >= 99999) return undefined
        const hundreds = Math.max(1, Math.round(num / 100))
        return 'BKN' + String(hundreds).padStart(3, '0')
    })()
    const ceiling = ceilingCloud ? parseInt(ceilingCloud.substring(3)) * 100 - elevation : Infinity
    const cross12 = calculateCrosswind(data.windDir, data.windSpeed, 122)
    const cross30 = calculateCrosswind(data.windDir, data.windSpeed, 302)
    const maxCrosswind = Math.max(cross12, cross30)
    const tempF = toFahrenheit(data.temperature)
    const rh = Math.min(calculateHumidity(data.temperature, data.dewpoint), 100)
    const hi = calculateHeatIndex(tempF, rh)

    document.getElementById("weather-conditions").innerText =
        `Temperature: ${tempF.toFixed(1)}¬∞F | Relative Humidity: ${rh.toFixed(0)}%`

    // Determine flight status based on concentric restrictions
    const restrictingFactors = []
    const tempRestrictions = []
    let flightStatus = { level: 'all-clear', title: 'All Pilots Clear' }

    // Check most restrictive conditions first
    if (ceiling < 1500) {
        restrictingFactors.push(`‚òÅÔ∏è Ceiling ${ceiling} ft`)
    }
    if (data.visibility < 3) {
        restrictingFactors.push(`üëÅÔ∏è Visibility ${data.visibility} SM`)
    }
    if (data.windSpeed >= 30) {
        restrictingFactors.push(`üå¨Ô∏è ${data.windSpeed} knots`)
        flightStatus = { level: 'all-restricted', title: 'All Flights Restricted' }
    } else if (maxCrosswind > 20) {
        restrictingFactors.push(`üå¨Ô∏è Crosswind ${maxCrosswind.toFixed(1)} knots`)
        flightStatus = { level: 'all-restricted', title: 'All Flights Restricted' }
    } else if (data.windSpeed >= 25) {
        restrictingFactors.push(`üå¨Ô∏è ${data.windSpeed} knots`)
        flightStatus = { level: 'commercial-only', title: 'Commercial/Instrument Only' }
    } else if (maxCrosswind > 15) {
        restrictingFactors.push(`üå¨Ô∏è Crosswind ${maxCrosswind.toFixed(1)} knots`)
        flightStatus = { level: 'commercial-only', title: 'Commercial/Instrument Only' }
    } else if (data.windSpeed >= 20) {
        restrictingFactors.push(`üå¨Ô∏è ${data.windSpeed} knots`)
        flightStatus = { level: 'private-only', title: 'Private+ Only' }
    } else if (maxCrosswind > 10) {
        restrictingFactors.push(`üå¨Ô∏è Crosswind ${maxCrosswind.toFixed(1)} knots`)
        flightStatus = { level: 'private-only', title: 'Private+ Only' }
    } else if (restrictingFactors.length > 0) {
        flightStatus = { level: 'all-restricted', title: 'All Flights Restricted' }
    }

    // Check heat index and temperature restrictions
    if (hi >= 105 || tempF <= 5) {
        tempRestrictions.push(hi >= 105 ? `üå°Ô∏è Heat Index ${hi.toFixed(0)}¬∞F` : `‚ùÑÔ∏è Temperature ${tempF.toFixed(0)}¬∞F`)
        if (flightStatus.level !== 'all-restricted') {
            flightStatus = { level: 'all-restricted', title: 'All Flights Restricted' }
        }
    } else if (hi >= 100) {
        tempRestrictions.push(`üå°Ô∏è Heat Index ${hi.toFixed(0)}¬∞F - Diamond Restricted`)
    } else if (tempF <= 14) {
        tempRestrictions.push(`‚ùÑÔ∏è Temperature ${tempF.toFixed(0)}¬∞F - No solos/XC`)
    } else if (tempF <= 23) {
        tempRestrictions.push(`‚ùÑÔ∏è Temperature ${tempF.toFixed(0)}¬∞F - Preheat required`)
    } else if (tempF < 32) {
        tempRestrictions.push(`‚ùÑÔ∏è Temperature ${tempF.toFixed(0)}¬∞F - Avoid extended power-off`)
    }

    // Update flight status display
    const statusCard = document.getElementById('overall-flight-status')
    statusCard.className = `flight-status-card ${flightStatus.level}`
    statusCard.querySelector('.status-title').textContent = flightStatus.title

    // Combine all restrictions for display
    const allRestrictions = [...restrictingFactors, ...tempRestrictions]
    if (allRestrictions.length > 0) {
        statusCard.querySelector('.status-details').textContent = `Restricting factors: ${allRestrictions.join(', ')}`
    } else {
        statusCard.querySelector('.status-details').textContent = 'No weather restrictions in effect'
    }

    // Handle heat index restrictions
    [["heat-index-105", hi >= 105], ["heat-index-100", hi >= 100], ["temp-32", tempF < 32],
    ["temp-23", tempF <= 23], ["temp-14", tempF <= 14], ["temp-5", tempF <= 5]].forEach(([id, restrict]) => {
        document.getElementById(`${id}-status`).innerText = restrict ? "Restricted" : "Not Restricted"
        if (restrict) document.getElementById(id).classList.add("highlight")
    })
}

async function fetchWeatherData() {
    try {
        // Try to fetch from pre-parsed JSON first
        const jsonData = await fetchWeatherDataFromJSON();
        
        if (jsonData) {
            console.log("Using weather data from JSON file");
            
            // Always display both METARs
            if (jsonData.kcps && jsonData.kcps.metar) {
                document.getElementById("kcps-metar").innerText = `KCPS METAR:\n${jsonData.kcps.metar}`;
            }
            
            if (jsonData.kstl && jsonData.kstl.metar) {
                document.getElementById("kstl-metar").innerText = `KSTL METAR:\n${jsonData.kstl.metar}`;
            }
            
            // Process KCPS data for restrictions if recent
            if (jsonData.kcps && jsonData.kcps.metar) {
                const kcpsData = {
                    windDir: jsonData.kcps.windDirection || 0,
                    windSpeed: jsonData.kcps.windSpeed || 0,
                    visibility: jsonData.kcps.visibility || 10,
                    clouds: jsonData.kcps.cloudCeiling ? [jsonData.kcps.cloudCeiling] : [],
                    temperature: jsonData.kcps.temperatureC || 0,
                    dewpoint: jsonData.kcps.dewPointC || 0,
                    timestamp: jsonData.kcps.timestamp ? new Date(jsonData.kcps.timestamp) : null
                };
                
                if (kcpsData.timestamp && kcpsData.timestamp >= twoHoursAgo) {
                    checkRestrictions(kcpsData, kcpsElevation);
                    return; // Exit after processing KCPS
                }
            }
            
            // If KCPS is old or unavailable, use KSTL data for restrictions
            if (jsonData.kstl && jsonData.kstl.metar) {
                const kstlData = {
                    windDir: jsonData.kstl.windDirection || 0,
                    windSpeed: jsonData.kstl.windSpeed || 0,
                    visibility: jsonData.kstl.visibility || 10,
                    clouds: jsonData.kstl.cloudCeiling ? [jsonData.kstl.cloudCeiling] : [],
                    temperature: jsonData.kstl.temperatureC || 0,
                    dewpoint: jsonData.kstl.dewPointC || 0,
                    timestamp: jsonData.kstl.timestamp ? new Date(jsonData.kstl.timestamp) : null
                };
                
                if (kstlData.timestamp && kstlData.timestamp >= twoHoursAgo) {
                    checkRestrictions(kstlData, 605);
                }
            }
        } else {
            console.warn("Could not load weather data from JSON file");
            document.getElementById("kcps-metar").innerText = "Weather data unavailable";
        }
    } catch (err) {
        console.error("Error fetching weather data:", err);
        document.getElementById("kcps-metar").innerText = "Error loading weather data";
    }
}

async function fetchAnnouncements() {
    try {
        const owner = 'CenterForDigitalHumanities';
        const repo = 'aviation-dashboard';
        
        // Fetch discussions directly from GitHub API
        // Note: This uses the public REST API endpoint for discussions
        const discussionsUrl = `https://api.github.com/repos/${owner}/${repo}/discussions`;
        
        const response = await fetch(discussionsUrl, {
            headers: {
                'Accept': 'application/vnd.github.v3+json'
            }
        });

        if (!response.ok) {
            console.warn(`GitHub API returned ${response.status}, falling back to default announcement`);
            showDefaultAnnouncement();
            return;
        }

        const discussions = await response.json();
        
        // Filter for announcements (category name or label)
        const announcements = discussions
            .filter(d => d.category?.name === 'Announcements')
            .filter(d => d.state === 'open')
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at)) // Newest first
            .slice(0, 10) // Limit to 10 most recent
            .map(d => ({
                title: d.title,
                content: d.body || '',
                date: d.created_at
            }));
        
        if (announcements.length === 0) {
            const container = document.getElementById('announcements-content');
            container.innerHTML = `
                <div class="announcement-item">
                    <div class="announcement-title">No announcements at this time</div>
                    <div class="announcement-content">Check back later for updates.</div>
                </div>
            `;
            return;
        }

        displayAnnouncements(announcements);

    } catch (error) {
        console.error('Error fetching announcements:', error);
        showDefaultAnnouncement();
    }
}

function displayAnnouncements(announcements) {
    const container = document.getElementById('announcements-content');
    
    container.innerHTML = announcements.map(announcement => {
        const date = new Date(announcement.date || announcement.createdAt).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        // Convert markdown to basic HTML (simple implementation)
        const content = (announcement.content || announcement.body || '')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/\n/g, '<br>');

        return `
            <div class="announcement-item">
                <div class="announcement-date">${date}</div>
                <div class="announcement-title">${announcement.title}</div>
                <div class="announcement-content">${content}</div>
            </div>
        `;
    }).join('');
}

function showDefaultAnnouncement() {
    const container = document.getElementById('announcements-content');
    container.innerHTML = `
        <div class="announcement-item">
            <div class="announcement-date">October 9, 2025</div>
            <div class="announcement-title">Welcome to the Aviation Dashboard</div>
            <div class="announcement-content">This dashboard provides real-time weather conditions and flight
                restrictions for SLU Aviation operations. Please check this section regularly for important updates.
            </div>
        </div>
    `;
}

fetchWeatherData();
fetchAnnouncements();
</script>
</body>
</html>
